# Generated by Django 4.1.13 on 2026-01-15 14:44

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('documents', '__first__'),
        ('applications', '__first__'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('borrowers', '__first__'),
        ('lenders', '__first__'),
        ('consultants', '__first__'),
    ]

    operations = [
        migrations.CreateModel(
            name='Deal',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('deal_id', models.CharField(blank=True, help_text='Unique deal identifier (e.g., DEAL-001)', max_length=20, unique=True)),
                ('status', models.CharField(choices=[('active', 'Active'), ('completed', 'Completed'), ('cancelled', 'Cancelled'), ('on_hold', 'On Hold')], default='active', max_length=20)),
                ('facility_type', models.CharField(choices=[('bridge', 'Bridge Loan'), ('term', 'Term Loan'), ('development', 'Development Finance')], max_length=20)),
                ('jurisdiction', models.CharField(default='UK', max_length=50)),
                ('accepted_at', models.DateTimeField(auto_now_add=True)),
                ('target_completion_date', models.DateField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('commercial_terms', models.JSONField(default=dict, help_text='Snapshot of commercial terms at acceptance')),
                ('completion_readiness_score', models.IntegerField(default=0, help_text='Completion readiness score (0-100)')),
                ('completion_readiness_breakdown', models.JSONField(blank=True, default=dict, help_text='Breakdown of what is preventing 100% readiness')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('application', models.OneToOneField(help_text='The application this deal was created from', on_delete=django.db.models.deletion.CASCADE, related_name='deal', to='applications.application')),
                ('borrower_company', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='deals', to='borrowers.borrowerprofile')),
            ],
            options={
                'ordering': ['-accepted_at'],
            },
        ),
        migrations.CreateModel(
            name='DealParty',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('party_type', models.CharField(choices=[('borrower', 'Borrower'), ('lender', 'Lender'), ('admin', 'Admin'), ('valuer', 'Valuer'), ('monitoring_surveyor', 'Monitoring Surveyor'), ('solicitor', 'Solicitor')], max_length=30)),
                ('acting_for_party', models.CharField(blank=True, choices=[('lender', 'Lender'), ('borrower', 'Borrower')], help_text='Required for consultants: who they are acting for', max_length=20, null=True)),
                ('firm_name', models.CharField(blank=True, max_length=200)),
                ('sra_number', models.CharField(blank=True, help_text='SRA number for solicitors', max_length=50)),
                ('rics_number', models.CharField(blank=True, help_text='RICS number for surveyors', max_length=50)),
                ('is_active_lender_solicitor', models.BooleanField(default=False, help_text='Only ONE lender solicitor can be active per deal')),
                ('appointment_status', models.CharField(choices=[('invited', 'Invited'), ('pending_confirmation', 'Pending Confirmation'), ('confirmed', 'Confirmed'), ('active', 'Active'), ('removed', 'Removed')], default='invited', max_length=20)),
                ('confirmed_at', models.DateTimeField(blank=True, help_text='When consultant confirmed appointment', null=True)),
                ('access_granted_at', models.DateTimeField(blank=True, null=True)),
                ('removed_at', models.DateTimeField(blank=True, null=True)),
                ('removal_reason', models.TextField(blank=True)),
                ('invited_at', models.DateTimeField(auto_now_add=True)),
                ('borrower_profile', models.ForeignKey(blank=True, help_text='Borrower profile (if party is borrower)', null=True, on_delete=django.db.models.deletion.CASCADE, to='borrowers.borrowerprofile')),
                ('consultant_profile', models.ForeignKey(blank=True, help_text='Consultant profile (if party is consultant)', null=True, on_delete=django.db.models.deletion.CASCADE, to='consultants.consultantprofile')),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='parties', to='deals.deal')),
                ('invited_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='invited_deal_parties', to=settings.AUTH_USER_MODEL)),
                ('lender_profile', models.ForeignKey(blank=True, help_text='Lender profile (if party is lender)', null=True, on_delete=django.db.models.deletion.CASCADE, to='lenders.lenderprofile')),
                ('user', models.ForeignKey(blank=True, help_text='User account for this party (null for borrower/lender as they use profile users)', null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='DealStage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('stage_number', models.PositiveIntegerField()),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField(blank=True)),
                ('entry_criteria', models.JSONField(blank=True, default=list, help_text='List of conditions that must be met to enter this stage')),
                ('exit_criteria', models.JSONField(blank=True, default=list, help_text='List of conditions that must be met to exit this stage')),
                ('sla_target_days', models.PositiveIntegerField(blank=True, help_text='Target number of days to complete this stage', null=True)),
                ('status', models.CharField(choices=[('not_started', 'Not Started'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('blocked', 'Blocked')], default='not_started', max_length=20)),
                ('entered_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('required_tasks', models.JSONField(blank=True, default=list)),
                ('optional_tasks', models.JSONField(blank=True, default=list)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='stages', to='deals.deal')),
            ],
            options={
                'ordering': ['deal', 'stage_number'],
            },
        ),
        migrations.CreateModel(
            name='LawFirm',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('firm_name', models.CharField(max_length=200, unique=True)),
                ('sra_number', models.CharField(blank=True, help_text='SRA registration number', max_length=50)),
                ('primary_contact_name', models.CharField(blank=True, max_length=100)),
                ('primary_contact_email', models.EmailField(blank=True, max_length=254)),
                ('primary_contact_phone', models.CharField(blank=True, max_length=30)),
                ('coverage_regions', models.JSONField(blank=True, default=list, help_text='List of regions/areas this firm covers')),
                ('specialisms', models.JSONField(blank=True, default=list, help_text="List of specialisms (e.g., 'commercial property', 'development finance')")),
                ('compliance_validated', models.BooleanField(default=False)),
                ('compliance_validated_at', models.DateTimeField(blank=True, null=True)),
                ('average_acknowledgment_hours', models.FloatField(blank=True, null=True)),
                ('average_requisition_response_hours', models.FloatField(blank=True, null=True)),
                ('average_cp_satisfaction_hours', models.FloatField(blank=True, null=True)),
                ('average_completion_days', models.FloatField(blank=True, null=True)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('compliance_validated_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='validated_law_firms', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='PerformanceMetric',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('consultant_firm', models.CharField(blank=True, help_text='For non-panel consultants', max_length=200)),
                ('metric_type', models.CharField(choices=[('acknowledgment_time', 'Acknowledgment Time'), ('requisition_response_time', 'Requisition Response Time'), ('cp_satisfaction_time', 'CP Satisfaction Time'), ('completion_time', 'Completion Time'), ('stage_dwell_time', 'Stage Dwell Time'), ('task_completion_time', 'Task Completion Time')], max_length=50)),
                ('average_value', models.FloatField(help_text='Average in hours or days as appropriate')),
                ('median_value', models.FloatField(blank=True, null=True)),
                ('min_value', models.FloatField(blank=True, null=True)),
                ('max_value', models.FloatField(blank=True, null=True)),
                ('count', models.PositiveIntegerField(help_text='Number of observations')),
                ('period_start', models.DateField()),
                ('period_end', models.DateField()),
                ('calculated_at', models.DateTimeField(auto_now_add=True)),
                ('law_firm', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='performance_metrics', to='deals.lawfirm')),
                ('solicitor_user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='solicitor_metrics', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'ordering': ['-period_end', 'metric_type'],
            },
        ),
        migrations.CreateModel(
            name='LawFirmPanelMembership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_active', models.BooleanField(default=True)),
                ('preferred_for_facility_types', models.JSONField(blank=True, default=list, help_text='Facility types this firm is preferred for')),
                ('preferred_for_regions', models.JSONField(blank=True, default=list, help_text='Regions this firm is preferred for')),
                ('added_at', models.DateTimeField(auto_now_add=True)),
                ('added_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('law_firm', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='panel_memberships', to='deals.lawfirm')),
                ('lender', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='panel_memberships', to='lenders.lenderprofile')),
            ],
        ),
        migrations.CreateModel(
            name='Drawdown',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('sequence_number', models.PositiveIntegerField(help_text='Drawdown sequence (1, 2, 3...)')),
                ('requested_amount', models.DecimalField(decimal_places=2, max_digits=15)),
                ('purpose', models.TextField(help_text='Purpose of this drawdown')),
                ('milestone', models.CharField(blank=True, help_text='Build milestone this drawdown relates to', max_length=200)),
                ('ims_inspection_required', models.BooleanField(default=True)),
                ('ims_inspection_date', models.DateField(blank=True, null=True)),
                ('lender_approval_status', models.CharField(choices=[('requested', 'Requested'), ('ims_inspection_required', 'IMS Inspection Required'), ('ims_certified', 'IMS Certified'), ('lender_review', 'Lender Review'), ('approved', 'Approved'), ('paid', 'Paid'), ('rejected', 'Rejected')], default='requested', max_length=30)),
                ('approved_at', models.DateTimeField(blank=True, null=True)),
                ('paid_at', models.DateTimeField(blank=True, null=True)),
                ('payment_reference', models.CharField(blank=True, max_length=100)),
                ('retention_amount', models.DecimalField(blank=True, decimal_places=2, help_text='Retention amount held back', max_digits=15, null=True)),
                ('contingencies', models.JSONField(blank=True, default=list, help_text='List of contingencies or conditions')),
                ('requested_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_drawdowns', to=settings.AUTH_USER_MODEL)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='drawdowns', to='deals.deal')),
                ('ims_certificate_document', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ims_certificates', to='documents.document')),
                ('ims_report_document', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ims_drawdown_reports', to='documents.document')),
            ],
            options={
                'ordering': ['deal', 'sequence_number'],
            },
        ),
        migrations.CreateModel(
            name='DealTask',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField(blank=True)),
                ('owner_party_type', models.CharField(help_text="Party type that owns this task (e.g., 'lender', 'solicitor')", max_length=30)),
                ('due_date', models.DateTimeField(blank=True, null=True)),
                ('sla_hours', models.PositiveIntegerField(blank=True, help_text='SLA in hours for this task', null=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('in_progress', 'In Progress'), ('completed', 'Completed'), ('blocked', 'Blocked'), ('cancelled', 'Cancelled')], default='pending', max_length=20)),
                ('priority', models.CharField(choices=[('critical', 'Critical'), ('high', 'High'), ('medium', 'Medium'), ('low', 'Low')], default='medium', max_length=20)),
                ('required_docs', models.JSONField(blank=True, default=list, help_text='List of document types/categories required for this task')),
                ('blockers', models.JSONField(blank=True, default=list, help_text='List of blockers preventing task completion')),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('assignee_party', models.ForeignKey(blank=True, help_text='Party assigned to this task', null=True, on_delete=django.db.models.deletion.SET_NULL, to='deals.dealparty')),
                ('assignee_user', models.ForeignKey(blank=True, help_text='Specific user assigned to this task', null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('completed_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='completed_tasks', to=settings.AUTH_USER_MODEL)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tasks', to='deals.deal')),
                ('dependencies', models.ManyToManyField(blank=True, help_text='Tasks that must be completed before this task can start', to='deals.dealtask')),
                ('stage', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='tasks', to='deals.dealstage')),
            ],
            options={
                'ordering': ['deal', 'stage', 'due_date', 'priority'],
            },
        ),
        migrations.CreateModel(
            name='DealRequisition',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('requisition_number', models.CharField(help_text='Requisition reference number', max_length=20)),
                ('subject', models.CharField(max_length=200)),
                ('question', models.TextField()),
                ('status', models.CharField(choices=[('open', 'Open'), ('responded', 'Responded'), ('approved', 'Approved'), ('rejected', 'Rejected'), ('closed', 'Closed')], default='open', max_length=20)),
                ('response', models.TextField(blank=True)),
                ('responded_at', models.DateTimeField(blank=True, null=True)),
                ('approved_at', models.DateTimeField(blank=True, null=True)),
                ('due_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_requisitions', to=settings.AUTH_USER_MODEL)),
                ('assigned_to', models.ForeignKey(blank=True, help_text='Borrower or borrower solicitor to respond', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='assigned_requisitions', to='deals.dealparty')),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='requisitions', to='deals.deal')),
                ('raised_by', models.ForeignKey(help_text='Lender solicitor who raised this requisition', on_delete=django.db.models.deletion.CASCADE, related_name='raised_requisitions', to='deals.dealparty')),
                ('responded_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='responded_requisitions', to=settings.AUTH_USER_MODEL)),
                ('response_documents', models.ManyToManyField(blank=True, related_name='requisition_responses', to='documents.document')),
            ],
            options={
                'ordering': ['deal', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='DealMessageThread',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('thread_type', models.CharField(choices=[('general', 'General (Borrower-Lender)'), ('legal', 'Legal (Lender + Lender Solicitor + Borrower Solicitor)'), ('valuation', 'Valuation (Lender + Valuer)'), ('ims', 'IMS (Lender + Monitoring Surveyor)')], default='general', max_length=20)),
                ('subject', models.CharField(blank=True, max_length=200)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('last_message_at', models.DateTimeField(blank=True, null=True)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='message_threads', to='deals.deal')),
                ('visible_to_parties', models.ManyToManyField(related_name='accessible_threads', to='deals.dealparty')),
            ],
            options={
                'ordering': ['deal', '-last_message_at'],
            },
        ),
        migrations.CreateModel(
            name='DealMessage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('message', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('attachments', models.ManyToManyField(blank=True, related_name='message_attachments', to='documents.document')),
                ('sender', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sent_messages', to='deals.dealparty')),
                ('sender_user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('thread', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='messages', to='deals.dealmessagethread')),
            ],
            options={
                'ordering': ['thread', 'created_at'],
            },
        ),
        migrations.CreateModel(
            name='DealDocumentLink',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('document_category', models.CharField(choices=[('compliance', 'Compliance (KYC/AML)'), ('legal', 'Legal'), ('reports', 'Reports'), ('financial', 'Financial'), ('drawdowns', 'Drawdowns')], max_length=50)),
                ('visibility', models.CharField(choices=[('borrower_only', 'Borrower Only'), ('lender_only', 'Lender Only'), ('shared', 'Shared (Borrower + Lender)'), ('consultant_scoped', 'Consultant Scoped'), ('legal_only', 'Legal Only (Solicitors)')], default='shared', max_length=30)),
                ('uploaded_at', models.DateTimeField(auto_now_add=True)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='document_links', to='deals.deal')),
                ('document', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='documents.document')),
                ('drawdown', models.ForeignKey(blank=True, help_text='If this document is related to a specific drawdown request', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='supporting_documents', to='deals.drawdown')),
                ('uploaded_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('visible_to_consultants', models.ManyToManyField(blank=True, related_name='scoped_documents', to='deals.dealparty')),
            ],
            options={
                'ordering': ['deal', '-uploaded_at'],
            },
        ),
        migrations.CreateModel(
            name='DealDecision',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('decision_type', models.CharField(choices=[('credit_signoff', 'Credit Sign-off'), ('cp_approval', 'CP Approval'), ('cp_rejection', 'CP Rejection'), ('drawdown_approval', 'Drawdown Approval'), ('completion_confirmation', 'Completion Confirmation'), ('stage_transition', 'Stage Transition')], max_length=30)),
                ('decision_text', models.TextField()),
                ('related_object_type', models.CharField(blank=True, help_text="e.g., 'DealCP', 'Drawdown'", max_length=50)),
                ('related_object_id', models.PositiveIntegerField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='decisions', to='deals.deal')),
                ('made_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('made_by_party', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='deals.dealparty')),
            ],
            options={
                'ordering': ['deal', '-created_at'],
            },
        ),
        migrations.CreateModel(
            name='DealCP',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('cp_number', models.CharField(help_text='CP reference number (e.g., CP1, CP2)', max_length=20)),
                ('title', models.CharField(max_length=200)),
                ('description', models.TextField()),
                ('is_mandatory', models.BooleanField(default=True)),
                ('owner_party_type', models.CharField(help_text='Party type responsible for satisfying this CP', max_length=30)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('satisfied', 'Satisfied'), ('rejected', 'Rejected'), ('waived', 'Waived')], default='pending', max_length=20)),
                ('satisfied_at', models.DateTimeField(blank=True, null=True)),
                ('approved_at', models.DateTimeField(blank=True, null=True)),
                ('rejected_at', models.DateTimeField(blank=True, null=True)),
                ('rejection_reason', models.TextField(blank=True)),
                ('due_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_cps', to=settings.AUTH_USER_MODEL)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='conditions_precedent', to='deals.deal')),
                ('evidence_documents', models.ManyToManyField(blank=True, related_name='cp_evidence', to='documents.document')),
                ('owner_party', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='owned_cps', to='deals.dealparty')),
                ('rejected_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='rejected_cps', to=settings.AUTH_USER_MODEL)),
                ('satisfied_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='satisfied_cps', to=settings.AUTH_USER_MODEL)),
                ('stage', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='cps', to='deals.dealstage')),
            ],
            options={
                'ordering': ['deal', 'cp_number'],
            },
        ),
        migrations.AddField(
            model_name='deal',
            name='current_stage',
            field=models.ForeignKey(blank=True, help_text='Current stage of the deal', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='active_deals', to='deals.dealstage'),
        ),
        migrations.AddField(
            model_name='deal',
            name='lender',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='deals', to='lenders.lenderprofile'),
        ),
        migrations.CreateModel(
            name='AuditEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('event_type', models.CharField(choices=[('deal_created', 'Deal Created'), ('stage_entered', 'Stage Entered'), ('stage_completed', 'Stage Completed'), ('task_created', 'Task Created'), ('task_assigned', 'Task Assigned'), ('task_completed', 'Task Completed'), ('cp_satisfied', 'CP Satisfied'), ('cp_approved', 'CP Approved'), ('cp_rejected', 'CP Rejected'), ('requisition_raised', 'Requisition Raised'), ('requisition_responded', 'Requisition Responded'), ('document_uploaded', 'Document Uploaded'), ('document_viewed', 'Document Viewed'), ('document_downloaded', 'Document Downloaded'), ('party_invited', 'Party Invited'), ('party_confirmed', 'Party Confirmed'), ('solicitor_appointed', 'Solicitor Appointed'), ('solicitor_replaced', 'Solicitor Replaced'), ('drawdown_requested', 'Drawdown Requested'), ('drawdown_certified', 'Drawdown Certified'), ('drawdown_approved', 'Drawdown Approved'), ('drawdown_paid', 'Drawdown Paid'), ('completion_confirmed', 'Completion Confirmed'), ('kyc_reviewed', 'KYC Reviewed'), ('aml_check_completed', 'AML Check Completed')], max_length=50)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('object_type', models.CharField(blank=True, help_text="Type of object affected (e.g., 'DealTask', 'DealCP')", max_length=50)),
                ('object_id', models.PositiveIntegerField(blank=True, null=True)),
                ('diff_summary', models.JSONField(blank=True, default=dict, help_text='Summary of changes made (before/after)')),
                ('metadata', models.JSONField(blank=True, default=dict, help_text='Additional event metadata')),
                ('actor_party', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='deals.dealparty')),
                ('actor_user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('deal', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='audit_events', to='deals.deal')),
            ],
            options={
                'ordering': ['deal', '-timestamp'],
            },
        ),
        migrations.AddIndex(
            model_name='performancemetric',
            index=models.Index(fields=['law_firm', 'metric_type', '-period_end'], name='deals_perfo_law_fir_948918_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='lawfirmpanelmembership',
            unique_together={('lender', 'law_firm')},
        ),
        migrations.AlterUniqueTogether(
            name='drawdown',
            unique_together={('deal', 'sequence_number')},
        ),
        migrations.AddIndex(
            model_name='dealtask',
            index=models.Index(fields=['deal', 'status'], name='deals_dealt_deal_id_d6fd45_idx'),
        ),
        migrations.AddIndex(
            model_name='dealtask',
            index=models.Index(fields=['assignee_user', 'status'], name='deals_dealt_assigne_9adeb2_idx'),
        ),
        migrations.AddIndex(
            model_name='dealtask',
            index=models.Index(fields=['due_date'], name='deals_dealt_due_dat_9bdeca_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='dealstage',
            unique_together={('deal', 'stage_number')},
        ),
        migrations.AlterUniqueTogether(
            name='dealrequisition',
            unique_together={('deal', 'requisition_number')},
        ),
        migrations.AddIndex(
            model_name='dealparty',
            index=models.Index(fields=['deal', 'party_type'], name='deals_dealp_deal_id_ea1d8e_idx'),
        ),
        migrations.AddIndex(
            model_name='dealparty',
            index=models.Index(fields=['deal', 'is_active_lender_solicitor'], name='deals_dealp_deal_id_0a114c_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='dealparty',
            unique_together={('deal', 'user', 'party_type')},
        ),
        migrations.AlterUniqueTogether(
            name='dealdocumentlink',
            unique_together={('deal', 'document')},
        ),
        migrations.AlterUniqueTogether(
            name='dealcp',
            unique_together={('deal', 'cp_number')},
        ),
        migrations.AddIndex(
            model_name='deal',
            index=models.Index(fields=['lender', '-accepted_at'], name='deals_deal_lender__764b0f_idx'),
        ),
        migrations.AddIndex(
            model_name='deal',
            index=models.Index(fields=['borrower_company', '-accepted_at'], name='deals_deal_borrowe_195104_idx'),
        ),
        migrations.AddIndex(
            model_name='deal',
            index=models.Index(fields=['status', '-accepted_at'], name='deals_deal_status_229c6a_idx'),
        ),
        migrations.AddIndex(
            model_name='auditevent',
            index=models.Index(fields=['deal', '-timestamp'], name='deals_audit_deal_id_faf47a_idx'),
        ),
        migrations.AddIndex(
            model_name='auditevent',
            index=models.Index(fields=['actor_user', '-timestamp'], name='deals_audit_actor_u_bd4591_idx'),
        ),
        migrations.AddIndex(
            model_name='auditevent',
            index=models.Index(fields=['event_type', '-timestamp'], name='deals_audit_event_t_a5a7a5_idx'),
        ),
    ]
